name: Keep Render Alive

on:
  schedule:
    # Run every 7 minutes to prevent Render free tier sleep (10 min inactivity)
    - cron: '*/7 * * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping health endpoint (with retries for cold start)
        run: |
          MAX_RETRIES=3
          RETRY_DELAY=60
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."
            
            if curl -f -s --max-time 90 "${{ secrets.RENDER_URL }}/health"; then
              echo "Health check successful!"
              break
            else
              echo "Health check failed."
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Waiting ${RETRY_DELAY}s before retry..."
                sleep $RETRY_DELAY
              fi
            fi
          done
      
      - name: Trigger auto crawl (with retries)
        run: |
          MAX_RETRIES=3
          RETRY_DELAY=60
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Trigger attempt $i of $MAX_RETRIES..."
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.RENDER_URL }}/api/scheduler/trigger" \
              -H "Content-Type: application/json" \
              --max-time 90)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "Response: $BODY (HTTP $HTTP_CODE)"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "Scheduler triggered successfully!"
              break
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Waiting ${RETRY_DELAY}s before retry..."
                sleep $RETRY_DELAY
              fi
            fi
          done
