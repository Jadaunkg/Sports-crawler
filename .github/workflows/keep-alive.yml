name: Keep Render Alive

on:
  schedule:
    # Run every 9 minutes (prevent Render free tier sleep)
    - cron: '*/9 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Health Endpoint
        run: |
          echo "Pinging Sports Crawler API to keep it alive..."
          
          if [ -z "${{ secrets.RENDER_URL }}" ]; then
            echo "ERROR: RENDER_URL secret is not configured!"
            echo "Please add the secret in GitHub Settings → Secrets and variables → Actions"
            exit 1
          fi
          
          API_URL="${{ secrets.RENDER_URL }}"
          echo "Attempting to ping: $API_URL/health"
          
          # Use curl with verbose error output and longer timeout
          response=$(curl -s -w "\n%{http_code}" -m 45 --connect-timeout 15 "$API_URL/health" 2>&1)
          http_code=$(echo "$response" | tail -n1)
          
          echo "Response code: $http_code"
          
          if [ "$http_code" = "200" ]; then
            echo "✓ API is alive and responsive"
          else
            echo "⚠ API returned status code: $http_code"
            echo "Full response:"
            echo "$response"
            # Don't exit with error - Render cold starts are normal
          fi
      
      - name: Trigger Scheduler (Fallback)
        run: |
          echo "Triggering scheduler endpoint..."
          API_URL="${{ secrets.RENDER_URL }}"
          curl -s -m 45 -X POST "$API_URL/api/scheduler/trigger" -H "Content-Type: application/json" | head -c 200 || echo "Scheduler trigger could not reach API"
